<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ ì¡ì•„ë´ë¼ ê²Œì„</title>
    <link rel="stylesheet" href="./css/catchMe.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-body">
        <div class="game-container" id="gameContainer">
            <h1>ğŸ® ë‚˜ ì¡ì•„ë´ë¼ ê²Œì„ ğŸ®</h1>
            <div class="instructions">
                ë¹ ë¥´ê²Œ ì›€ì§ì´ëŠ” ë²„íŠ¼ë“¤ì„ ì¡ì•„ë³´ì„¸ìš”!<br>
                20ì´ˆ ì•ˆì— ìµœëŒ€í•œ ë§ì´ ì¡ìœ¼ì„¸ìš”!
            </div>
            <label for="nickname-input">ë‹‰ë„¤ì„ì€ ì˜ì–´ì™€ 12ì ì´ë‚´ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”</label>
            <input type="text" class="nickname-input" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            <div class="score" id="score">ì ìˆ˜: 0</div>
            <div class="timer" id="timer">ì‹œê°„: 20ì´ˆ</div>
            <button class="start-button" id="startButton">ê²Œì„ ì‹œì‘!</button>
            
            <!-- <div class="ranking" id="ranking">
                <h3>ğŸ† ë­í‚¹ ğŸ†</h3>
                <div id="rankingList"></div>
            </div> -->
        </div>
    
        <div class="game-area" id="gameArea" style="display: none;">
            <div class="score" style="position: absolute; top: 20px; left: 20px; z-index: 100;">ì ìˆ˜: <span id="gameScore">0</span></div>
            <div class="timer" style="position: absolute; top: 20px; right: 20px; z-index: 100;">ì‹œê°„: <span id="gameTimer">20</span>ì´ˆ</div>
        </div>
    
        <div class="game-over" id="gameOver">
            <div>ğŸ‰ ê²Œì„ ì¢…ë£Œ! ğŸ‰</div>
            <div style="margin: 1rem 0; font-size: 1.5rem;">ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span></div>
            <button class="restart-button" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
            <button class="save-button" onclick="saveScore()">ì ìˆ˜ ì €ì¥</button>
        </div>
    </div>


    <script>
      const supabaseUrl = 'https://xgxajgqqqirzhohqwtyc.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneGFqZ3FxcWlyemhvaHF3dHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyOTc4MjQsImV4cCI6MjA2OTg3MzgyNH0.atWmo_9wUpEZFOjuPX0zeXRwIh2UVtI5yoJOF9BKBOo';
      const client = supabase.createClient(supabaseUrl, supabaseKey);

      const USER_GAME_DATA = {
        userName:'',
        userScore: 0,
      }

      let score = 0;
      let timeLeft = 20;
      let gameInterval;
      let buttonInterval;
      let buttons = [];
      let isGameRunning = false;
      let rankings = JSON.parse(localStorage.getItem('gameRankings')) || [];
      
      const isNicknameValid = (nickname) => {
        const regex = /^[a-zA-Z]{1,12}$/;
        return regex.test(nickname);
      }
      
      const startButton = document.getElementById('startButton');
      const gameContainer = document.getElementById('gameContainer')
      const gameArea = document.getElementById('gameArea');
      const gameOver = document.getElementById('gameOver');
      const gameScore = document.getElementById('gameScore');
      const gameTimer = document.getElementById('gameTimer');
      const finalScore = document.getElementById('finalScore');
      const nicknameInput = document.getElementById('nicknameInput');
      const rankingList = document.getElementById('rankingList');
      // ë­í‚¹ í‘œì‹œ
      // displayRankings();
      // ê²Œì„ ì‹œì‘
      startButton.addEventListener('click', startGame);
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹‰ë„¤ì„ ì…ë ¥ì°½ ì´ˆê¸°í™”
      window.addEventListener('load', () => {
          nicknameInput.value = '';
      });
      function startGame() {
          const nickname = nicknameInput.value.trim();
          if(!isNicknameValid(nickname)) {
              alert('ë‹‰ë„¤ì„ì€ ì˜ë¬¸ì 1~12ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!');
              return;
          }
          if (!nickname) {
              alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
              return;
          }
          isGameRunning = true;
          score = 0;
          timeLeft = 20;
          startButton.style.display = 'none';
          gameContainer.style.display = 'none';
          gameArea.style.display = 'block';
          
          // ì ìˆ˜ì™€ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
          updateScore();
          updateTimer();
          
          // ê²Œì„ íƒ€ì´ë¨¸ ì‹œì‘
          gameInterval = setInterval(() => {
              timeLeft--;
              updateTimer();
              if (timeLeft <= 0) {
                  endGame(nickname);
              }
          }, 1000);
          
          // ë²„íŠ¼ ìƒì„± ì‹œì‘
          createButtons();
          
          // ë°°ê²½ ì ë“¤ ìƒì„±
          createDots();
      }
      function createButtons() {
          buttonInterval = setInterval(() => {
              if (!isGameRunning) return;
              
              // ìƒˆë¡œìš´ ë²„íŠ¼ ìƒì„± (3-6ê°œ)
              const buttonCount = Math.floor(Math.random() * 4) + 3;
              for (let i = 0; i < buttonCount; i++) {
                    createButton();
                }
            }, 800); // 0.8ì´ˆë§ˆë‹¤ ìƒˆ ë²„íŠ¼ ìƒì„±
        }

        function createButton() {
            const button = document.createElement('button');
            button.className = 'ping-button';
            button.textContent = 'ì¡ì•„ë³´ì„¸ìš”!';
            
            // ëœë¤ ìœ„ì¹˜ ì„¤ì •
            const maxX = window.innerWidth - 80;
            const maxY = window.innerHeight - 80;
            const x = Math.random() * maxX;
            const y = Math.random() * maxY;
            
            button.style.left = x + 'px';
            button.style.top = y + 'px';
            
            // í´ë¦­ ì´ë²¤íŠ¸
            button.addEventListener('click', () => {
                if (isGameRunning) {
                    score += 10;
                    updateScore();
                    button.remove();
                    buttons = buttons.filter(btn => btn !== button);
                }
            });
            
            gameArea.appendChild(button);
            buttons.push(button);
            
            // 1-3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ê¸°
            const disappearTime = Math.random() * 2000 + 1000; // 1-3ì´ˆ
            setTimeout(() => {
                if (button.parentNode) {
                    button.remove();
                    buttons = buttons.filter(btn => btn !== button);
                }
            }, disappearTime);
        }

        function createDots() {
            for (let i = 0; i < 50; i++) {
                const dot = document.createElement('div');
                dot.className = 'dots';
                dot.style.left = Math.random() * window.innerWidth + 'px';
                dot.style.top = Math.random() * window.innerHeight + 'px';
                dot.style.animationDelay = Math.random() * 1 + 's';
                document.body.appendChild(dot);
            }
        }

        function updateScore() {
            gameScore.textContent = score;
        }

        function updateTimer() {
            gameTimer.textContent = timeLeft;
        }

        function endGame(nickname) {
            isGameRunning = false;
            clearInterval(gameInterval);
            clearInterval(buttonInterval);
            
            // ë²„íŠ¼ë“¤ ì œê±°
            buttons.forEach(btn => {
                if (btn.parentNode) {
                    btn.remove();
                }
            });
            buttons = [];
            
            // ë­í‚¹ì— ì¶”ê°€
            // addToRanking(nickname, score);
            USER_GAME_DATA.userName = nickname;
            USER_GAME_DATA.userScore = score;
            
            // ê²Œì„ ì˜¤ë²„ í™”ë©´ í‘œì‹œ
            finalScore.textContent = score;
            gameOver.style.display = 'block';
        }

        const saveScore = async() => {
          const {userName, userScore} = USER_GAME_DATA;
          // console.log(userName,userScore, typeof userScore);
          
          const {data, error} = await client
            .from('catchMe')
            .insert([{ userName: userName, userScore: userScore }]);

          if (error) {
            alert('ë­í‚¹ ì €ì¥ ì‹¤íŒ¨ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            window.location.reload();
            return;
          }

          const input = confirm('ë­í‚¹ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ë­í‚¹ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ì–´ìš”?');
          if (input) {
            window.location.href = 'rankings.html?game=catchMe';
          } else {
            window.location.href = 'index.html';
          }
        }

        function restartGame() {
          window.location.reload();
        }

        // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì •
        window.addEventListener('resize', () => {
            if (isGameRunning) {
                buttons.forEach(btn => {
                    const maxX = window.innerWidth - 80;
                    const maxY = window.innerHeight - 80;
                    const x = Math.random() * maxX;
                    const y = Math.random() * maxY;
                    btn.style.left = x + 'px';
                    btn.style.top = y + 'px';
                });
            }
        });
    </script>
</body>
</html>
