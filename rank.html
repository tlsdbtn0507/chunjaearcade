<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rank</title>
  </head>
  <link rel="stylesheet" href="./css/rank.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
    rel="stylesheet"
  />
  <body>
    <div class="container">
      <div class="main-box">
        <div class="title"></div>
        <button class="start-btn">game start</button>
        <div class="ranking-box">
          <img class="trophy" src="./src/trophy.png" alt="trophy" />
          <div class="ranking-title">RANKING</div>
          <div class="ranking-list">
          </div>
        </div>
      </div>
      <button class="arrow-btn">
        <img
          class="arrow-img"
          src="https://cdn-icons-png.flaticon.com/512/271/271220.png"
          alt="arrow"
        />
      </button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
      const GAME_OBJECTS = [
        {
          gameName: "steelKing",
          title: "Steel King Steel Kim",
        },
        {
          gameName: "catchMe",
          title: "Catch me If you can",
        },
        {
          gameName: "ddongpihagi",
          title: "DdongPiHaGi",
        },
        {
          gameName: "reactionTest",
          title: "ReactionRateTest",
        },
      ];

      const supabaseUrl = 'https://xgxajgqqqirzhohqwtyc.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneGFqZ3FxcWlyemhvaHF3dHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyOTc4MjQsImV4cCI6MjA2OTg3MzgyNH0.atWmo_9wUpEZFOjuPX0zeXRwIh2UVtI5yoJOF9BKBOo';
      
      const client = supabase.createClient(supabaseUrl, supabaseKey);

      const gameTitle = document.querySelector(".title");
      const gameStartBtn = document.querySelector(".start-btn");

      let gameUrl;

      const setTitleOfPage = () => {
        const urlParam = new URLSearchParams(window.location.search);
        const game = urlParam.get("game");

        const {gameName,title} = GAME_OBJECTS.find(gameObj => gameObj.gameName === game);
        
        gameUrl = gameName;
        gameTitle.innerText = title;
      };

      setTitleOfPage();


      const rankScoreChar = (game)=>{
        if(game === "steelKing"){
          return "sec";
        } else if(game === "catchMe"){
          return "";
        } else if(game === "ddongpihagi"){
          return "";
        } else if(game === "reactionTest"){
          return "ms";
        }
      }

      const fetchTop3Rankings = async() => {

        const {data,error} = await client
          .from(gameUrl)
          .select('*')
          .order('userScore', { ascending: gameUrl !== 'catchMe' && gameUrl !== 'ddongpihagi' })
          .limit(3);

        if (error) {
          console.error("랭킹 데이터 불러오기 실패", error);
          alert("랭킹 데이터를 불러오는 데 실패했습니다.");
          window.location.href = "index.html";
          return;
        }

        if (!error && data.length === 0) {
          document.querySelector('.ranking-list').innerHTML = '<p>아직 데이터가 없습니다</p>';
          return;
        }
        const rankingList = document.querySelector(".ranking-list");
        rankingList.innerHTML = ""; // 기존 랭킹 데이터 초기화
        data.forEach((player, index) => {
          rankingList.innerHTML +=
          `<p class="ranking-item">
            <span class="rank">${index + 1}.</span>
            <span class="name">${player.userName}</span>
            <span class="time">${player.userScore}${rankScoreChar(gameUrl)}</span><br>
          </p>`;
        });
      };
      fetchTop3Rankings()


      gameStartBtn.addEventListener('click',()=>{
        window.location.href = gameUrl
      })


    </script>
  </body>
</html>
