<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>반응속도 테스트</title>
    <link rel="stylesheet" href="./css/reaction.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- 시작 화면 -->
        <div class="start-screen" id="startScreen">
            <div class="emoji">⚡</div>
            <h1 class="title">반응속도 테스트</h1>
            <p class="subtitle">빨간색 화면에서 초록색으로 바뀌면 빠르게 클릭하세요!</p>
            <button class="start-btn" onclick="showNicknameScreen()">테스트 시작하기</button>
            
        </div>

        <!-- 닉네임 입력 화면 -->
        <div class="nickname-screen" id="nicknameScreen">
            <div class="emoji">👤</div>
            <h1 class="title">닉네임 입력</h1>
            <p class="subtitle">테스트에 사용할 닉네임을 입력해주세요!</p>
            <p class="subtitle">닉네임은 영어 12자 이내로 작성해주세요</p>
            <input type="text" class="nickname-input" id="nicknameInput" placeholder="닉네임을 입력하세요" maxlength="10">
            <br>
            <button class="nickname-btn" id="nicknameBtn" onclick="showInstructionScreen()">다음</button>
        </div>

        <!-- 게임 설명 화면 -->
        <div class="instruction-screen" id="instructionScreen">
            <div class="emoji">📋</div>
            <h1 class="title">게임 방법</h1>
            <div class="instruction-list">
                <div class="instruction-item">
                    <div class="instruction-number">1</div>
                    <div class="instruction-text">빨간색 화면에서는 아무것도 안누르고 기다립니다.</div>
                </div>
                <div class="instruction-item">
                    <div class="instruction-number">2</div>
                    <div class="instruction-text">초록색 화면이 나오면 재빨리 누릅니다.</div>
                </div>
                <div class="instruction-item">
                    <div class="instruction-number">3</div>
                    <div class="instruction-text">만약, 실수로 빨간색 화면에서 클릭하면 패널티가 부여됩니다.</div>
                </div>
            </div>
            <button class="instruction-btn" onclick="startGameWithNickname()">게임 시작</button>
        </div>

        <!-- 게임 화면 -->
        <div class="game-screen" id="gameScreen">
            <!-- 게임 화면은 색깔만 표시 -->
        </div>
        
        <!-- 게임 정보 (게임 화면 밖에 배치) -->
        <div class="game-info" id="gameInfo" style="display: none;">
            <div class="progress">
                <span class="score">시도 <span id="currentAttempt">1</span> / <span id="totalAttempts">5</span></span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="game-message" id="gameMessage">기다리세요...</div>
            <div class="reaction-time" id="reactionTime"></div>
        </div>

        <!-- 결과 화면 -->
        <div class="result-screen" id="resultScreen">
            <div class="emoji" id="resultEmoji">🎯</div>
            <h1 class="title">테스트 완료!</h1>
            
            <div class="final-stats">
                <div class="stat-item">
                    <div class="stat-value" id="avgTime">0ms</div>
                    <div class="stat-label">평균 반응속도</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="bestTime">0ms</div>
                    <div class="stat-label">최고 기록</div>
                </div>
            </div>

            <!-- <div class="attempt-list" id="attemptList">
                시도 기록이 여기에 표시됩니다
            </div> -->

            <button class="restart-btn" onclick="restartGame()">다시 시작하기</button>
            <button class="goResult-btn" onclick="goToCheckRank()">저장하고 순위보기</button>
            
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://xgxajgqqqirzhohqwtyc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneGFqZ3FxcWlyemhvaHF3dHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyOTc4MjQsImV4cCI6MjA2OTg3MzgyNH0.atWmo_9wUpEZFOjuPX0zeXRwIh2UVtI5yoJOF9BKBOo';
      
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        const searchParams = new URLSearchParams(window.location.search);
        const game = searchParams.get('game');
        
        const GAME_RESULT = {
            userName: '',
            userScore: 0,
        };

        const isNicknameValid = (nickname) => {
            const regex = /^[a-zA-Z]{1,12}$/;
            return regex.test(nickname);
        }

        let currentAttempt = 0;
        let totalAttempts = 5;
        let reactionTimes = [];
        let currentNickname = '';
        let rankings = [];
        let gameState = 'waiting'; // waiting, ready, clicked
        let startTime = 0;
        let waitTimer = null;
        let gameScreen = null;

        // 닉네임 화면 표시
        function showNicknameScreen() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('nicknameScreen').style.display = 'block';
            document.getElementById('nicknameInput').focus();
        }

        // 설명 화면 표시
        function showInstructionScreen() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            if (!isNicknameValid(nickname)) {
                alert('닉네임은 영어로 1~12자 이내로 입력해주세요!');
                return;
            }
            if (nickname.length < 2) {
                alert('닉네임을 2글자 이상 입력해주세요!');
                return;
            }
            
            currentNickname = nickname;
            document.getElementById('nicknameScreen').style.display = 'none';
            document.getElementById('instructionScreen').style.display = 'block';
        }

        // 닉네임으로 게임 시작
        function startGameWithNickname() {
            document.getElementById('instructionScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gameInfo').style.display = 'block';
            startAttempt();
        }

        // 시도 시작
        function startAttempt() {
            if (currentAttempt >= totalAttempts) {
                showResult();
                return;
            }

            currentAttempt++;
            document.getElementById('currentAttempt').textContent = currentAttempt;
            document.getElementById('totalAttempts').textContent = totalAttempts;
            
            // 진행률 업데이트
            const progress = (currentAttempt / totalAttempts) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // 게임 화면 초기화
            gameScreen = document.getElementById('gameScreen');
            gameState = 'waiting'; // 상태 초기화
            gameScreen.className = 'game-screen waiting';
            gameScreen.onclick = handleFoulClick; // 반칙 클릭 처리 추가
            
            const gameMessage = document.getElementById('gameMessage');
            const reactionTime = document.getElementById('reactionTime');
            
            gameMessage.textContent = '기다리세요...';
            reactionTime.textContent = '';

            // 랜덤 시간 후 초록색으로 변경 (2~7초)
            const randomDelay = Math.random() * 5000 + 2000; // 2~7초
            
            waitTimer = setTimeout(() => {
                gameState = 'ready';
                gameScreen.className = 'game-screen ready';
                gameMessage.textContent = '지금 누르세요!';
                startTime = Date.now();
                gameScreen.onclick = handleClick;
            }, randomDelay);
        }

        // 반칙 클릭 처리
        function handleFoulClick() {
            if (gameState !== 'waiting') return;

            // 타이머 정리
            if (waitTimer) {
                clearTimeout(waitTimer);
            }

            gameState = 'clicked';
            gameScreen.className = 'game-screen clicked';
            gameScreen.onclick = null;
            
            const gameMessage = document.getElementById('gameMessage');
            const reactionTime = document.getElementById('reactionTime');
            
            gameMessage.textContent = '삐빅! 반칙입니다!';
            reactionTime.textContent = '700ms (패널티)';

            // 패널티 시간 추가 (700ms)
            reactionTimes.push(700);

            // 2초 후 다음 시도 (반칙 메시지를 더 오래 보여줌)
            setTimeout(() => {
                startAttempt();
            }, 2000);
        }

        // 클릭 처리
        function handleClick() {
            if (gameState !== 'ready') return;

            const endTime = Date.now();
            const reactionTime = endTime - startTime;
            
            reactionTimes.push(reactionTime);
            
            gameState = 'clicked';
            gameScreen.className = 'game-screen clicked';
            gameScreen.onclick = null;
            
            const gameMessage = document.getElementById('gameMessage');
            const reactionTimeDisplay = document.getElementById('reactionTime');
            
            gameMessage.textContent = '클릭됨!';
            reactionTimeDisplay.textContent = reactionTime + 'ms';

            // 1초 후 다음 시도
            setTimeout(() => {
                startAttempt();
            }, 1000);
        }

        // 결과 표시
        function showResult() {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
            
            const avgTime = Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length);
            const bestTime = Math.min(...reactionTimes);
            
            document.getElementById('avgTime').textContent = avgTime + 'ms';
            document.getElementById('bestTime').textContent = bestTime + 'ms';

            GAME_RESULT.userName = currentNickname;
            GAME_RESULT.userScore = avgTime;
        }

        // 랭킹 업데이트 함수
        const goToCheckRank = async () => {
            const {userName, userScore} = GAME_RESULT;
            const {data,error} = await client
                .from('reactionTest')
                .insert([{ userName, userScore }])
                .select();
            if (error) {
                console.error("랭킹 업데이트 실패", error);
                alert("랭킹 업데이트에 실패했습니다. 다시 시도해주세요.");
                window.location.reload();
                return;
            }
            const input = confirm("랭킹이 업데이트 되었습니다. 순위를 보시겠습니까?");
            if(input){
                window.location.href = `rankings.html?game=reactionTest`;
            } else {
                window.location.href = 'index.html';
            }   
        }

        // 게임 재시작
        function restartGame() {
            currentAttempt = 0;
            reactionTimes = [];
            currentNickname = '';
            
            // 타이머 정리
            if (waitTimer) {
                clearTimeout(waitTimer);
            }
            
            // 닉네임 입력 초기화
            document.getElementById('nicknameInput').value = '';
            
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'none';
            document.getElementById('instructionScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            
            // 랭킹 다시 표시
            // displayRanking('rankingList');
        }

        // 랭킹 업데이트 함수
        function updateRanking(nickname, avgTime) {
            // 기존 닉네임이 있으면 제거
            rankings = rankings.filter(rank => rank.nickname !== nickname);
            
            // 새로운 점수 추가 (반응속도는 낮을수록 좋으므로 음수로 저장)
            rankings.push({ nickname, score: -avgTime });
            
            // 점수순으로 정렬 (높은 점수 우선, 즉 빠른 시간 우선)
            rankings.sort((a, b) => b.score - a.score);
            
            // 상위 10명만 유지
            rankings = rankings.slice(0, 10);
            
            // 로컬 스토리지에 저장
            localStorage.setItem('reactionRankings', JSON.stringify(rankings));
        }

        // 로컬 스토리지에서 랭킹 로드
        function loadRankings() {
            const savedRankings = localStorage.getItem('reactionRankings');
            if (savedRankings) {
                rankings = JSON.parse(savedRankings);
            }
        }

        // 랭킹 초기화 함수
        function clearRankings() {
            if (confirm('정말로 모든 랭킹 기록을 삭제하시겠습니까?')) {
                rankings = [];
                localStorage.removeItem('reactionRankings');
                displayRanking('rankingList');
                alert('랭킹이 초기화되었습니다!');
            }
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            // 랭킹 로드
            loadRankings();
            // displayRanking('rankingList');
        };

        // 엔터키로 닉네임 입력
        document.getElementById('nicknameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') startGameWithNickname();
        });

    </script>
</body>
</html> 