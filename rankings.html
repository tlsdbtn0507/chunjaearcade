<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="./css/rankings.css" />
  <title>랭킹 보드</title>
</head>
<body>
  <div class="leaderboard-container">
    <div class="ranking-header">
    </div>
    <div class="scroll-wrapper">
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>STAND</th>
            <th>NAME</th>
            <th class="score"></th>
            <th>DATE</th>
          </tr>
        </thead>
        <tbody class="ranking-table-body" id="rankingBody">
          <!-- 랭킹 데이터가 여기에 추가됩니다 -->
        </tbody>
      </table>
    </div>
    <div class="blackBg">
      <img style="z-index: 2;" src="./src/char1-1.png" alt="">
      <img style="z-index: 2;" src="./src/char2-1.png" alt="">
      <img style="z-index: 2;" src="./src/char3-1.png" alt="">
    </div>
  </div>

  <!-- 뒤로가기 버튼 -->
  <button class="back-button" onclick="goHome()"></button>
  <script>
    const GAME_OBJECTS = [
      {
        gameName: "steelKing",
        title: "Steel King Steel Kim",
      },
      {
        gameName: "catchMe",
        title: "Catch me If you can",
      },
      {
        gameName: "ddongpihagi",
        title: "DdongPiHaGi",
      },
      {
        gameName: "reactionTest",
        title: "ReactionRateTest",
      },
    ];
    const supabaseUrl = 'https://xgxajgqqqirzhohqwtyc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneGFqZ3FxcWlyemhvaHF3dHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyOTc4MjQsImV4cCI6MjA2OTg3MzgyNH0.atWmo_9wUpEZFOjuPX0zeXRwIh2UVtI5yoJOF9BKBOo';
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    let imgFlag = true

    setInterval(()=>{
      document.querySelectorAll('.blackBg img').forEach((img, index) => {
        if(imgFlag) {
          img.src = `./src/char${index + 1}-1.png`;
        } else {
          img.src = `./src/char${index + 1}-2.png`;
        }
        imgFlag = !imgFlag;
      });
    },500)

    const searchParams = new URLSearchParams(window.location.search);
    const game = searchParams.get('game');

    const handleInnerHTML = (game) => {
      const {title} = GAME_OBJECTS.find(obj => obj.gameName === game);
      document.querySelector('.ranking-header').innerText = 
      `Rankings of ${title}`;
      if (game === 'catchMe' || game === 'ddongpihagi') {
        document.querySelector('.score').innerText = 'Score';
      } else {
        document.querySelector('.score').innerText = 'Time';
      }
    };
    handleInnerHTML(game);

    
    const rankScoreChar = (game)=>{
      if(game === "steelKing"){
        return "sec";
      } else if(game === "catchMe"){
        return "";
      } else if(game === "ddongpihagi"){
        return "";
      } else if(game === "reactionTest"){
        return "ms";
      }
    }

    const getOrdinalSuffix = (rank) => {
      const j = rank % 10, k = rank % 100;
      if (j === 1 && k !== 11) return `${rank}st`;
      if (j === 2 && k !== 12) return `${rank}nd`;
      if (j === 3 && k !== 13) return `${rank}rd`;
      return `${rank}th`;
    };

    const assignRanks = (players) => {
      if(game === 'catchMe' || game === 'ddongpihagi') {
        players.sort((a, b) => b.time - a.time);
      } else {
        players.sort((a, b) => a.time - b.time);
      }

      let rank = 1, prevTime = null, sameRankCount = 0;
      return players.map((player) => {
        if (player.time === prevTime) {
          sameRankCount++;
        } else {
          rank += sameRankCount;
          sameRankCount = 1;
        }
        prevTime = player.time;
        return { ...player, rankText: getOrdinalSuffix(rank) };
      });
    };

    const addRow = (stand, name, time, date) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${stand}</td>
        <td>${name}</td>
        <td>${time}</td>
        <td>${date}</td>
      `;
      document.querySelector(".ranking-table-body").appendChild(row);
    };

    const fetchRankings = async (game) => {
      const { data, error } = await client
        .from(game)
        .select('*')
        .order('userScore', { ascending: true });

      if (error) {
        console.error("데이터 불러오기 실패", error);
        return;
      }

      if(!error && data.length === 0) {
        document.querySelector('.ranking-table-body').innerHTML = 
        '<tr><td colspan="4">아직 데이터가 없습니다</td></tr>';
        return;
      }

      const dataArr = data.map(item => {
        const d = new Date(item.created_at);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        let hours = d.getHours();
        const minutes = String(d.getMinutes()).padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        if (hours === 0) hours = 12;

        return {
          name: item.userName,
          time: item.userScore,
          timeText: `${item.userScore}${rankScoreChar(game)}`,
          date: `${yyyy}. ${mm}. ${dd}. ${ampm} ${String(hours).padStart(2, '0')}:${minutes}`
        };
      });

      const ranked = assignRanks(dataArr);
      ranked.forEach(r => addRow(r.rankText, r.name, r.timeText, r.date));
      isScroll();
    };


    fetchRankings(game); // or catchMe, reactionRateTest 등
    handleInnerHTML(game);

    const isScroll = () =>{
      const rows = document.querySelectorAll('.ranking-table-body tr').length;
      const table = document.querySelector('.leaderboard-table');
      const container = document.querySelector('.scroll-wrapper');

      if (rows <= 10) return; // 10개 이하면 스크롤 안 함

      // 이동해야 할 거리 = (테이블 전체 높이 - 컨테이너 높이)
      const distance = table.offsetHeight - container.clientHeight;
      if (distance <= 0) return;

      // px/s 기준 속도 설정 (원하는 느낌으로 조절)
      const SPEED = 40; // 예: 40px/s
      const durationSec = distance / SPEED;

      // CSS 변수/속성 주입
      table.style.setProperty('--scroll-distance', `-${distance}px`);
      table.style.animationDuration = `${durationSec}s`;

      // 2초 뒤 시작 (요구사항 유지)
      setTimeout(() => {
        table.classList.add('scroll-animate');
      }, 2000);
    }

    // isScroll();
    const goHome = () => window.location.href = 'index.html';
  </script>
</body>
</html>
