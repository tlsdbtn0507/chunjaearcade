<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ’© í”¼í•˜ê¸° ê²Œì„</title>
  <link href="./css/ddongpihagi.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="game-wrapper">
    <div class="score">ğŸ’© í”¼í•œ ì ìˆ˜: <span id="score">0</span></div>
    <div class="game-area" id="gameArea">
      <div class="player" id="player"></div>
    </div>
    <div class="controls">
      <button class="btn" onclick="moveLeft()">â—€</button>
      <button class="btn" onclick="moveRight()">â–¶</button>
    </div>
  </div>
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modalContent"></div>
  </div>
<script>

  const supabaseUrl = 'https://xgxajgqqqirzhohqwtyc.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneGFqZ3FxcWlyemhvaHF3dHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyOTc4MjQsImV4cCI6MjA2OTg3MzgyNH0.atWmo_9wUpEZFOjuPX0zeXRwIh2UVtI5yoJOF9BKBOo';
  const client = supabase.createClient(supabaseUrl, supabaseKey);

  const isNicknameValid = (nickname) => {
    const regex = /^[a-zA-Z]{1,12}$/;
    return regex.test(nickname);
  };

  const gameWrapper = document.querySelector('.game-wrapper');
  const gameArea = document.getElementById('gameArea');
  const player = document.getElementById('player');
  const scoreEl = document.getElementById('score');
  const modalOverlay = document.getElementById('modalOverlay');
  const modalContent = document.getElementById('modalContent');

  const playerWidth = 50;
  const poopSize = 40;
  let wrapperWidth ;
  let playerX;
  let poops = [];
  let score = 0;
  let gameOver = false;
  let fallSpeed = 2;
  let direction = 'left';

  function getWrapperWidth() {
    return gameWrapper.offsetWidth;
  }

  function randomX() {
    return Math.random() * (getWrapperWidth() - poopSize);
  }

  function updatePlayer() {
    player.style.left = `${playerX}px`;
    player.style.backgroundImage = direction === 'left' ? "url('./src/people1.png')" : "url('./src/people2.png')";
  }

  function moveLeft() {
    direction = 'left';
    playerX = Math.max(0, playerX - 30);
    updatePlayer();
  }

  function moveRight() {
    direction = 'right';
    playerX = Math.min(getWrapperWidth() - playerWidth, playerX + 30);
    updatePlayer();
  }


  // ğŸ¯ í‚¤ë³´ë“œ ì´ë²¤íŠ¸
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') moveLeft();
    if (e.key === 'ArrowRight') moveRight();
  });

  function createPoopElements() {
    poops.forEach((poop, i) => {
      let el = document.getElementById(`poop-${i}`);
      if (!el) {
        el = document.createElement('div');
        el.className = 'poop';
        el.id = `poop-${i}`;
        gameArea.appendChild(el);
      }
      el.style.left = `${poop.x}px`;
      el.style.top = `${poop.y}px`;
    });
  }

  function updatePoops() {
    if (gameOver) return;
    fallSpeed = 2 + Math.floor(score / 5);

    poops = poops.map((poop, i) => {
      poop.y += fallSpeed;

      const playerTop = 470;
      const playerBottom = 520;

      const hit = poop.y + poopSize >= playerTop &&
                  poop.y <= playerBottom &&
                  poop.x < playerX + playerWidth &&
                  poop.x + poopSize > playerX;

      if (hit) endGame();

      if (poop.y > 620) {
        score++;
        scoreEl.textContent = score;
        return { x: randomX(), y: -Math.random() * 300 };
      }

      return poop;
    });

    createPoopElements();
  }

  function gameLoop() {
    updatePoops();
    if (!gameOver) requestAnimationFrame(gameLoop);
  }

  function startGame() {
    modalOverlay.style.display = 'none';
    wrapperWidth = getWrapperWidth();
    playerX = wrapperWidth / 2 - playerWidth / 2;
    updatePlayer();
    poops = Array.from({ length: 3 }, () => ({ x: randomX(), y: -Math.random() * 300 }));
    score = 0;
    scoreEl.textContent = score;
    gameOver = false;
    fallSpeed = 2;
    gameLoop();
  }

  function endGame() {
    gameOver = true;
    showModal(score);
  }
  function showStartModal() {
    modalOverlay.style.display = 'flex';
    modalContent.innerHTML = `
      <h2>ê²Œì„ ë°©ë²•</h2>
      <p>ğŸ–± í™”ë©´ì˜ <b>â—€ / â–¶ ë²„íŠ¼</b>ì„ í´ë¦­í•˜ê±°ë‚˜<br>
      âŒ¨ í‚¤ë³´ë“œì˜ <b>ì¢Œ/ìš° ë°©í–¥í‚¤</b>ë¡œ ìºë¦­í„°ë¥¼ ì›€ì§ì´ì„¸ìš”!</p>
      <p>ğŸ’© ë˜¥ì„ í”¼í•´ ì˜¤ë˜ ì‚´ì•„ë‚¨ìœ¼ì„¸ìš”!</p>
      <button style="margin-top: 20px; padding: 10px 20px; font-size: 18px; cursor: pointer;"
        onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    `;
  }

  // ğŸš€ ì²« í™”ë©´ì— ëª¨ë‹¬ í‘œì‹œ
  showStartModal();

  function showModal(finalScore) {
    modalOverlay.style.display = 'flex';
    modalContent.innerHTML = `
      <h2>ğŸ’¥ ë‹¹ì‹ ì˜ ì ìˆ˜ëŠ” ${finalScore}ì !</h2>
      <span> ë‹‰ë„¤ì„ì€ ì˜ì–´ë¡œ 12ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
      <input class="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" />
      <button class="toHome" onclick="window.location.href='index.html'">í™ˆìœ¼ë¡œ</button>
      <button class="saveBtn"onclick="sendResult(${finalScore})">ì €ì¥í•˜ê¸°</button>
    `;
  }

  const sendResult = async (finalScore) => {
    const nickName = document.querySelector('.nickname').value.trim();
    if (!isNicknameValid(nickName) || nickName.length === 0) {
      alert('ë‹‰ë„¤ì„ì€ ì˜ì–´ë¡œ 12ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    const { data, error } = await client
      .from('ddongpihagi')
      .insert([{ userName: nickName, userScore: finalScore }]);

    if (error) {
      console.error('Error inserting data:', error);
      alert('ë°ì´í„° ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
    
    const input = confirm("ê²°ê³¼ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤. ë­í‚¹ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    if (input) {
      window.location.href = 'rankings.html?game=ddongpihagi';
    } else {
      window.location.href = 'index.html';
    }
  }

  // startGame();
</script>
</body>
</html>
